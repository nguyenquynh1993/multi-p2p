#labels Mobicents,OpenIMS
= Introduction =

Install IMS Core and Mobicents AS with real IP address 


= I) Install OpenIMSCore with IP localhost : 127.0.0.1 =
==1. Prerequisites:==
a. libxml2 
b. libmysql 
c. bind9
d. bison
e. flex
f. mysql-server
g. ant
h. make
i. jdk1.5
j. gcc3/4  

==2. Go to / directory through command prompt and ==
{{{
mkdir opt
cd opt
mkdir OpenIMSCore
cd OpenIMSCore
mkdir ser_ims
mkdir FHoSS
}}}
==3. Change the permissions for opt folder created: ==
{{{ 
chmod 777 -R /opt 
}}}

==4. Check out the code for OpenIMSCore==
{{{
cd /opt/OpenIMSCore/  
}}}

==5.Create a new directory ser_ims and checkout the CSCFs there:==
{{{
mkdir ser_ims
svn checkout http://svn.berlios.de/svnroot/repos/openimscore/ser_ims/trunk ser_ims
}}}
==6.Create a new directory FHoSS and checkout the HSS there:==
{{{
mkdir FHoSS
svn checkout http://svn.berlios.de/svnroot/repos/openimscore/FHoSS/trunk FHoSS
}}}
==7.Compile ser_ims ==
{{{ 
cd ser_ims
sudo make install-libs all
}}}
== 8.Configure FHoSS ==

  * If you don't have a JDK >=1.5, get one before proceeding

  * Make sure, that the JDK version that you are using is >= 1.5!!!

{{{ 
java -version 
}}}

  * Do "ant compile deploy" in FHoSS
  * New!!! "ant gen" is not needed any more!!!
{{{
cd FHoSS
ant compile
ant deploy
#cd .. 
}}}
== 9.Configure the Environment ==

  * All the installation examples configured to work only on the local loopback and the default domain configured as "open-ims.test".
  * The MySQL access rights are set only for local access 
  * We recommend that you try it first like this and then do your changes:
  # Replace 127.0.0.1 where required with your IP address 
  # Replace the home domain (open-ims.test) with your own one 
  # Change the database passwords 
  * For this operation the *ser_ims/cfg/configurator.sh* might help you. 

== 10.Configure DNS ==

  * A sample DNS zone file can be found in ser_ims/cfg/open-ims.dnszone

  * Edit */etc/bind/named.conf* by adding following zone in it:
{{{
          zone "open-ims.test" {
              type master;
              file "/etc/bind/open-ims.dnszone";
          };
}}}

  * Copy open-ims.dnszone file to */etc/bind/* 
{{{          
sudo cp ser_ims/cfg/open-ims.dnszone etc/bind/ 
}}}

  * Edit */etc/resolv.conf*
{{{          
            # Generated by NetworkManager
            search open-ims.test
            domain open-ims.test
            nameserver 127.0.0.1
}}}
  * Edit *etc/hosts*
{{{           
           127.0.0.1 localhost
           127.0.0.1 open-ims.test mobicents.open-ims.test ue.open-ims.test presence.open-ims.test icscf.open-ims.test scscf.open-ims.test pcscf.open- ims.test hss.open-ims.test

# The following lines are desirable for IPv6 capable hosts
::1 localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
ff02::3 ip6-allhosts
}}}
  * Restart bind server: 
{{{
   sudo /etc/init.d/bind9 restart
}}}


== 11. Configure MySQL ==
  * Run the SQL dumps (mysql -u root -p -h localhost < dump.sql):
{{{      
      mysql -u root -p -h localhost < ser_ims/cfg/icscf.sql
      mysql -u root -p -h localhost < FHoSS/scripts/hss_db.sql  
      mysql -u root -p -h localhost < FHoSS/scripts/userdata.sql
}}}
== 12. Start all nodes and hss: ==
{{{   
     cd opt/OpenIMSCore
     ./pcscf.sh
     ./scscf.sh
     ./icsscf.sh
     cd FHoSS/deploy
     sh startup.sh
}}}
= II) Configure OpenIMSCore with real IP  =

  # Edit /etc/resolv.conf
  # Edit /etc/hosts
  # Edit /etc/bind/open-ims.test
  # Restart bind: sudo /edit/init.d/bind9 restart
  # Check domain : 
{{{ 
   dig open-ims.test
}}}
  # Change Nodes setting: 
{{{
  icscf.cfg & icscf.xml (opt/OpenIMSCore/) 
  pcscf.cfg & pcscf.xml 
  scscf.cfg & scscf.xml 
}}}
  # Change FHoSS setting 
{{{ 
    DiameterPeerHSS.xml (FHoSS/deploy) 
    hss.properties (FHoSS/deploy)
}}}
=> Check the web interface on : http://127.0.0.1:8080/

  # Configuration port for HSS : 
  * Edit in file */opt/OpenIMSCore/FHoSS/config/hss.properties* and change 
{{{
host=157.159.16.91
port=8080
}}}

  * Edit in file */opt/OpenIMSCore/FHoSS/config/DiameterPeerHSS.xml* and change 
{{{
<Acceptor port="3868" bind="157.159.16.91" />
}}}

= III) Add new user in OpenIMSCore =
  * Change *scrip add-imscore-user_newdb.sh* (path *_/opt/OpenIMSCore/add-imscore-user_newdb.sh_* )to remove comments in created script sql 

  * Use scrip add-imscore-user_newdb.sh 
{{{
add-imscore-user.sh -u <user> [-t <tel-URI>] [-r <realm> -p <password>] [-a|-d]
  -u <user>: The username (e.g. 'brooke')
  -t <tel-URI>: The tel-URI (e.g. 'tel:+49123456789'). If used with -a, -d requires
     this parameter too!
  -r <realm>: The realm. Default is 'open-ims.test'
  -i <impi>: The Private Identity (e.g. 'brooke@open-ims.test'). The -u option overrides this.
  -b <impu>: The Public Identity (e.g. 'sip:brooke@open-ims.test') The -u option overrides this.
  -p <password>: The password. Default is value of -u option
  -a: Automatically apply created add script
  -d: Automatically apply created delete script
  -c: Delete the scripts afterwards (by default they are not deleted)

example : 
./add-imscore-user.sh -u tran
}}}

  * Edit in HSS by web interface : change the user name  
{{{ 
<USER>_imsu" (ex : tran_imsu) ---> <USER> (ex: tran)
}}}

=IV) Install Mobicents=
  # Install Mobicents with JBOSS Application Server with link (version JBOSS 4.3.2 ) http://www.mobicents.org/user_guides/sip_servlets/index.html#bssswjicar-binary-SIP_Servlets_Server_with_JBoss-Installing_Configuring_and_Running
  # Install application conference with link : http://www.mobicents.org/mss-ide-setup.html  
  # Install source code from Mobicents's repository 
  # Go to dictectory : * conference-demo/* and use the command line : 
{{{ 
mvn clean install -Pdeploy
}}}
  # Config of route SIP message to Application in file JBOSS_HOME/server/default/conf/dars/mobicents-dar.properties
{{{
OPTIONS: ("Conference", "DAR:From", "ORIGINATING", "", "NO_ROUTE", "0")
REGISTER: ("Conference", "DAR:From", "ORIGINATING", "", "NO_ROUTE", "0")
INVITE: ("Conference", "DAR:From", "ORIGINATING", "", "NO_ROUTE", "0")
MESSAGE: ("Conference", "DAR:From", "ORIGINATING", "", "NO_ROUTE", "0")
NOTIFY: ("Conference", "DAR:From", "ORIGINATING", "", "NO_ROUTE", "0")
SUBSCRIBE: ("Conference", "DAR:From", "ORIGINATING", "", "NO_ROUTE", "0")
}}}  
  # Run JBOSS Application with real IP: Go to the directory : *JBOSS_HOME/bin/*   
{{{
./run.sh -b [ip_address] 
ex:     
    ./run.sh -b 157.159.16.91
}}}
  # Test conference application by Sip phone as SJphone, X-lite, ... 
  * Run the Sip phone 
  * Config Sip phone with IP proxy : IP_Address_Mobicents:port (ex : 157.159.16.91:5080)
  